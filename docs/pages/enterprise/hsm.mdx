---
title: Teleport HSM Support
description: How to configure Harware Security Modules to hold your Teleport CA private keys
h1: Teleport HSM Support
---

Teleport can be configured to use a connected HSM to create and hold CA private
keys.

Most PKCS#11 HSMs should be supported, we test with AWS CloudHSM, YubiHSM2, and
SoftHSM2.

# Setup

Customers can follow our [Enterprise Getting Started Guide](./getting-started.mdx) for
instructions on how to setup Teleport Enterprise. You'll need to start with the Teleport
Enterprise Binary.

After downloading the binary tarball, run:

```bsh
$ tar -xzf teleport-ent-v(=teleport.version=)-linux-amd64-fips-bin.tar.gz
$ cd teleport-ent
$ sudo ./install
# This will copy Teleport Enterprise to /usr/local/bin.
```

# Teleport Configuration

Add the `ca_key_params` section to `/etc/teleport.yaml` on the auth server.

```yaml
teleport:
  ...

auth_service:
  enabled: true

  ...

  ca_key_params:
    pkcs11:
      # module_path should point to the location of your HSM's PKCS#11 library.
      module_path: /path/to/pkcs11/module.so
      
      # token_label should identify the PKCS#11 token Teleport should use to
      # connect to the HSM.
      token_label: <token-label>
      # some libraries use slot_number to identify the PKCS#11 instead of
      # token_label
      # slot_number: 1

      # pin should be the token pin
      pin: "username:password"
      # pin_path can optionally be used to read the pin from a file
      # pin_path: /path/to/pin_file
```

# Certificate Rotation

When adding a new HSM to an existing Teleport cluster, or adding a new
HSM-connected Auth server to an HA Teleport cluster, CA rotation needs to be
performed in order for the cluster to trust the new HSM certificates. `teleport`
will print a warning during startup if this needs to be completed, and will not
sign any certificates (except the `Admin` certificate used by `tctl` which will
be signed by a temporary HSM key). A warning will also be printed in `tctl
status` if this is required for any Auth server in the cluster.

CA rotation can be performed manually or automatically, see our admin guide on
[Certificate
rotation)[https://goteleport.com/docs/admin-guide/#certificate-rotation]. To rotate the CAs
manually, you will need to run:

```bash
tctl auth rotate --manual --phase init
# wait for all auth servers to generate new HSM keys
tctl auth rotate --manual --phase update_clients
# wait for all teleport servers and clients to reload and receive new certs
tctl auth rotate --manual --phase update_servers
# wait for all teleport servers to reload
tctl auth rotate --manual --phase standby
# rotation is complete
```

You should not need to wait for more than 2 minutes per phase if you are
initializing a new HA cluster with no connected nodes. If you are updating a
live cluster, make sure to wait for all nodes which may intermittently lose
connection to be able to receive new certs or they may lose access to the
cluster and have to re-join.

You may see some warnings or errors in the logs during rotation while the
servers are reloading, this is expected while the old instance is being
terminated. The logs should stabilize within 1-2 minutes.

# Examples

## YubiHSM2

1. Install the [YubiHSM2 SDK](https://developers.yubico.com/YubiHSM2/Releases/)
2. Use `yubihsm-shell` to create a new authentication key and delete the
default authentication key with default password
[https://developers.yubico.com/YubiHSM2/Usage_Guides/Admin_guide.html]. The new
password must be at least 8 characters long.
3. Start `yubihsm-connector`
[https://developers.yubico.com/YubiHSM2/Component_Reference/yubihsm-connector/]
4. Create a `yubihsm_pkcs11.conf` file pointing to your connector
[https://developers.yubico.com/YubiHSM2/Component_Reference/PKCS_11/].
5. Configure teleport with the path to YubiHSM2's PKCS11 module:
```yaml
teleport:
  ...

auth_service:
  ...
  ca_key_params:
    pkcs11:
      module_path: /usr/local/lib/pkcs11/yubihsm_pkcs11.dylib
      slot_number: <your token slot number>
      pin: "<key_id><password>" # eg "0001password"
      # pin_path can optionally be used to read the pin from a file
      # pin_path: /path/to/pin_file
```
6. Set the `YUBIHSM_PKCS11_CONF` environment variable to the path of your
`yubihsm-pkcs11.conf` file and start Teleport.

## AWS CloudHSM

1. Create a VPC in your desired region, with private subnets in each
desired Availability Zone.
2. Create a CloudHSM cluster in your VPC and subnets.
3. Initialize the cluster.
   a. Create an HSM in your desired AZ, wait for it to be created.
   b. Download the CSR (Certificate Signing Request).
   c. Sign the CSR with an appropriate CA.
   d. Upload the signed certificate and the issuing CA certificate to complete
      initialization of the HSM
4. Create an EC2 instance that can reach your HSM VPC subnet.
5. Add the security group named after the CloudHSM cluster to allow incoming
traffic from the cluster's security group on ports 2223-2225.
6. Copy the issuing certificate from step 3 to `/opt/cloudhsm/etc/customerCA.crt`
7. Install the AWS CloudHSM Client SDK 5
[https://docs.aws.amazon.com/cloudhsm/latest/userguide/pkcs11-library-install.html]
```bash
wget https://s3.amazonaws.com/cloudhsmv2-software/CloudHsmClient/EL6/cloudhsm-pkcs11-latest.el6.x86_64.rpm
sudo yum install ./cloudhsm-pkcs11-latest.el6.x86_64.rpm
```
8. Activate the cluster.
```bash
sudo /opt/cloudhsm/bin/configure --cmu <IP address>
/opt/cloudhsm/bin/cloudhsm_mgmt_util /opt/cloudhsm/etc/cloudhsm_mgmt_util.cfg
> listUsers
> loginHSM PRECO admin password
> changePswd PRECO admin <NewPassword>
> listUsers
# user `admin` should change from PRECO to CO(Crypto Officer)
```

9. Create a CU(Crypto User) User which Teleport will use to interact with your
HSM.
```bash
sudo /opt/cloudhsm/bin/configure --cmu <IP address>
/opt/cloudhsm/bin/cloudhsm_mgmt_util /opt/cloudhsm/etc/cloudhsm_mgmt_util.cfg
> loginHSM CO admin <password>
> createUser CU teleport_user <password>
```
10. Start the CloudHSM client.
```bash
  - sudo service cloudhsm-client start
```
11. Bootstrap the PKCS#11 SDK
```
sudo /opt/cloudhsm/bin/configure-pkcs11 -a <HSM IP address>
```
